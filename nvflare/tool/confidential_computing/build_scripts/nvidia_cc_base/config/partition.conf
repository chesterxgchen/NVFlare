# Installation settings
ISO_FILE="/path/to/ubuntu-22.04-server-amd64.iso"
ROOT_MOUNT="/mnt/build/root"

# Version and naming
VERSION="1.0.0"
OUTPUT_DIR="/opt/nvflare/images"  # Default output directory

# Image settings
OUTPUT_IMAGE_PREFIX="nvcc_image"
OUTPUT_IMAGE="${OUTPUT_DIR}/${OUTPUT_IMAGE_PREFIX}-${VERSION}.qcow2"
IMAGE_SIZE="32G"         # Total size reduced

# Installer settings
INSTALLER_PREFIX="cc_image_installer"
INSTALLER_NAME="${INSTALLER_PREFIX}-${VERSION}.sh"

# Device settings
TARGET_DEVICE=""  # Will be determined during installation
DEVICE="${TARGET_DEVICE}"     # For backward compatibility
AUTO_SELECT="true"  # Set to false to enable interactive selection

# Partition layout
PARTITIONS=(
    # Boot partition (unencrypted, host visible)
    "p1:512M:ext4:/boot:noauto,noatime"
    
    # Host-visible CC config partition 
    # - Unencrypted for host/TEE access during boot
    # - Contains: TEE measurements, launch policy, attestation config
    # - Mounted read-only from host OS
    "p2:256M:ext4:/host/cc:noauto,noatime,ro"
    
    # Root partition (encrypted, host invisible)
    # - Contains OS and system files
    "p3:20G+:ext4:/:defaults,noatime,resize"
    
    # CC Applications partition
    # - Contains CC applications and SDKs:
    #   - /etc/cc/apps: CC applications
    #   - /etc/cc/attestation: Attestation SDKs (AMD SNP/Intel ITA + NVIDIA NRAS)
    #   - /etc/cc/config: Runtime configs and secrets
    # - Encrypted and memory isolated
    # - Not visible to host OS
    "p4:5G+:ext4:/etc/cc:defaults,noatime,resize"
    
    # Dynamic partition
    # - For output data/results
    # - Encryption configurable at runtime
    # - Can be made visible to host if unencrypted
    # - Uses remaining space
    "p5:*:ext4:/dynamic:defaults,noatime"
)

# Mount points
APP_MOUNT="${ROOT_MOUNT}/app"
RO_MOUNT="${ROOT_MOUNT}/ro"
DYNAMIC_MOUNT="${ROOT_MOUNT}/dynamic"

# Encryption settings
LUKS_CIPHER="aes-xts-plain64"
LUKS_KEY_SIZE="512"
LUKS_HASH="sha256"

# Filesystem settings
ROOT_FS="ext4"
BOOT_FS="ext4"
EFI_FS="vfat"

# Verity settings
VERITY_HASH="sha256"
VERITY_SALT_SIZE="32"
VERITY_BLOCK_SIZE="4096"

# Security boundaries
HOST_VISIBLE_DIRS=(
    "/boot"      # Standard boot files
    "/host/cc"   # CC host configuration
    # Note: /dynamic may be visible depending on runtime config
)

ENCRYPTED_DIRS=(
    "/"          # Root filesystem
    "/etc/cc"    # CC apps and runtime config
    # Note: /dynamic encryption determined at runtime
)

# Dynamic encryption based on key file presence
DYNAMIC_PARTITION=(
    "mount=/dynamic"              # Mount point
    "keyfile=/host/cc/keys/dynamic.key"  # Key file path in host-visible area
    "fallback=unencrypted"        # What to do if key not found: unencrypted/error
    "owner=${CC_USER}:${CC_GROUP}"  # Ownership of mount point
    "mode=0750"                   # Permissions of mount point
)

# CC Application partition structure
CC_APP_DIRS=(
    "/etc/cc/apps:${CC_USER}:${CC_GROUP}:0750"        # CC applications
    "/etc/cc/attestation:${CC_USER}:${CC_GROUP}:0750" # Attestation SDKs
    "/etc/cc/config:${CC_USER}:${CC_GROUP}:0700"      # Runtime configs
)

# Dynamic partition settings
# DYNAMIC_ENCRYPT="runtime"  # Options: always, never, runtime
# DYNAMIC_ACCESS="runtime"   # Options: host, guest, runtime 

# Partition resize settings
PARTITION_RESIZE=(
    # Format: "partition:min_size:max_size:grow_weight"
    "p3:20G:80%:40"    # Root can grow to 80% of available space
    "p4:5G:20%:20"     # CC apps can grow to 20% of available space
    "p5:1G:*:40"       # Dynamic uses remaining space
) 